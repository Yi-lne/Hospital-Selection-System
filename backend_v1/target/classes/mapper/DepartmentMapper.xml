<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.HospitalSelection.mapper.DepartmentMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.chen.HospitalSelection.model.Department">
        <id column="id" property="id"/>
        <result column="hospital_id" property="hospitalId"/>
        <result column="dept_name" property="deptName"/>
        <result column="dept_intro" property="deptIntro"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, hospital_id, dept_name, dept_intro, is_deleted
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM hospital_department
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 根据医院ID查询所有科室 -->
    <select id="selectByHospitalId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM hospital_department
        WHERE hospital_id = #{hospitalId} AND is_deleted = 0
        ORDER BY id ASC
    </select>

    <!-- 根据医院ID和科室名称查询 -->
    <select id="selectByHospitalIdAndName" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM hospital_department
        WHERE hospital_id = #{hospitalId} AND dept_name = #{deptName} AND is_deleted = 0
    </select>

    <!-- 条件查询 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM hospital_department
        <where>
            is_deleted = 0
            <if test="hospitalId != null">
                AND hospital_id = #{hospitalId}
            </if>
            <if test="deptName != null and deptName != ''">
                AND dept_name LIKE CONCAT('%', #{deptName}, '%')
            </if>
        </where>
        ORDER BY id ASC
    </select>

    <!-- 搜索科室（支持模糊搜索） -->
    <select id="searchDepartments" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM hospital_department
        WHERE is_deleted = 0 AND dept_name LIKE CONCAT('%', #{keyword}, '%')
        <if test="hospitalId != null">
            AND hospital_id = #{hospitalId}
        </if>
        ORDER BY id ASC
        LIMIT #{limit}
    </select>

    <!-- 统计医院的科室数量 -->
    <select id="countByHospitalId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM hospital_department
        WHERE hospital_id = #{hospitalId} AND is_deleted = 0
    </select>

    <!-- 查询热门科室（根据医生数量排序） -->
    <select id="selectPopularDepartments" resultMap="BaseResultMap">
        SELECT d.id, d.hospital_id, d.dept_name, d.dept_intro, d.is_deleted
        FROM hospital_department d
        LEFT JOIN doctor_info doc ON d.id = doc.dept_id AND doc.is_deleted = 0
        WHERE d.hospital_id = #{hospitalId} AND d.is_deleted = 0
        GROUP BY d.id
        ORDER BY COUNT(doc.id) DESC
        LIMIT #{limit}
    </select>

    <!-- 插入科室 -->
    <insert id="insert" parameterType="com.chen.HospitalSelection.model.Department" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO hospital_department (hospital_id, dept_name, dept_intro, is_deleted)
        VALUES (#{hospitalId}, #{deptName}, #{deptIntro}, #{isDeleted})
    </insert>

    <!-- 批量插入科室 -->
    <insert id="insertBatch">
        INSERT INTO hospital_department (hospital_id, dept_name, dept_intro, is_deleted)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.hospitalId}, #{item.deptName}, #{item.deptIntro}, #{item.isDeleted})
        </foreach>
    </insert>

    <!-- 更新科室 -->
    <update id="update" parameterType="com.chen.HospitalSelection.model.Department">
        UPDATE hospital_department
        <set>
            <if test="deptName != null and deptName != ''">
                dept_name = #{deptName},
            </if>
            <if test="deptIntro != null">
                dept_intro = #{deptIntro},
            </if>
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 逻辑删除 -->
    <update id="deleteById">
        UPDATE hospital_department
        SET is_deleted = 1
        WHERE id = #{id}
    </update>

    <!-- 根据医院ID删除所有科室 -->
    <update id="deleteByHospitalId">
        UPDATE hospital_department
        SET is_deleted = 1
        WHERE hospital_id = #{hospitalId}
    </update>

    <!-- 批量逻辑删除 -->
    <update id="deleteBatch">
        UPDATE hospital_department
        SET is_deleted = 1
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
