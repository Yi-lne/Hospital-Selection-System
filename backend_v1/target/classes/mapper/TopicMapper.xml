<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.HospitalSelection.mapper.TopicMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.chen.HospitalSelection.model.Topic">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="disease_code" property="diseaseCode"/>
        <result column="board_level1" property="boardLevel1"/>
        <result column="board_level2" property="boardLevel2"/>
        <result column="board_type" property="boardType"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="like_count" property="likeCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="collect_count" property="collectCount"/>
        <result column="view_count" property="viewCount"/>
        <result column="status" property="status"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 话题详细信息映射（包含用户信息） -->
    <resultMap id="TopicWithUserResultMap" type="com.chen.HospitalSelection.model.Topic" extends="BaseResultMap">
        <result column="user_nickname" property="userNickname"/>
        <result column="user_avatar" property="userAvatar"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, user_id, disease_code, board_level1, board_level2, board_type,
        title, content, like_count, comment_count, collect_count, view_count,
        status, is_deleted, create_time, update_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM community_topic
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 根据ID查询（包含用户信息） -->
    <select id="selectWithUserById" resultMap="TopicWithUserResultMap">
        SELECT
            t.id, t.user_id, t.disease_code, t.board_level1, t.board_level2, t.board_type,
            t.title, t.content, t.like_count, t.comment_count, t.collect_count, t.view_count,
            t.status, t.is_deleted, t.create_time, t.update_time,
            u.nickname as user_nickname, u.avatar as user_avatar
        FROM community_topic t
        LEFT JOIN sys_user u ON t.user_id = u.id AND u.is_deleted = 0
        WHERE t.id = #{id} AND t.is_deleted = 0
    </select>

    <!-- 根据用户ID查询话题 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM community_topic
        WHERE user_id = #{userId} AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 根据板块查询话题 -->
    <select id="selectByBoard" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM community_topic
        WHERE board_level1 = #{boardLevel1} AND is_deleted = 0
        <if test="boardLevel2 != null and boardLevel2 != ''">
            AND board_level2 = #{boardLevel2}
        </if>
        <if test="boardType != null">
            AND board_type = #{boardType}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 条件查询 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM community_topic
        <where>
            is_deleted = 0
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="diseaseCode != null and diseaseCode != ''">
                AND disease_code = #{diseaseCode}
            </if>
            <if test="boardLevel1 != null and boardLevel1 != ''">
                AND board_level1 = #{boardLevel1}
            </if>
            <if test="boardLevel2 != null and boardLevel2 != ''">
                AND board_level2 = #{boardLevel2}
            </if>
            <if test="boardType != null">
                AND board_type = #{boardType}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%')
                OR content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 分页查询 -->
    <select id="selectByPage" resultMap="TopicWithUserResultMap">
        SELECT
            t.id, t.user_id, t.disease_code, t.board_level1, t.board_level2, t.board_type,
            t.title, t.content, t.like_count, t.comment_count, t.collect_count, t.view_count,
            t.status, t.is_deleted, t.create_time, t.update_time,
            u.nickname as user_nickname, u.avatar as user_avatar
        FROM community_topic t
        LEFT JOIN sys_user u ON t.user_id = u.id AND u.is_deleted = 0
        WHERE t.is_deleted = 0
        <if test="boardLevel1 != null and boardLevel1 != ''">
            AND t.board_level1 = #{boardLevel1}
        </if>
        <if test="boardLevel2 != null and boardLevel2 != ''">
            AND t.board_level2 = #{boardLevel2}
        </if>
        <if test="boardType != null">
            AND t.board_type = #{boardType}
        </if>
        <if test="status != null">
            AND t.status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (t.title LIKE CONCAT('%', #{keyword}, '%')
            OR t.content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY
        <choose>
            <when test="sortField == 'createTime'">t.create_time DESC</when>
            <when test="sortField == 'likeCount'">t.like_count DESC</when>
            <when test="sortField == 'viewCount'">t.view_count DESC</when>
            <otherwise>t.create_time DESC</otherwise>
        </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计总数 -->
    <select id="countByCondition" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM community_topic
        WHERE is_deleted = 0
        <if test="boardLevel1 != null and boardLevel1 != ''">
            AND board_level1 = #{boardLevel1}
        </if>
        <if test="boardLevel2 != null and boardLevel2 != ''">
            AND board_level2 = #{boardLevel2}
        </if>
        <if test="boardType != null">
            AND board_type = #{boardType}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
            OR content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 搜索话题 -->
    <select id="searchTopics" resultMap="TopicWithUserResultMap">
        SELECT
            t.id, t.user_id, t.disease_code, t.board_level1, t.board_level2, t.board_type,
            t.title, t.content, t.like_count, t.comment_count, t.collect_count, t.view_count,
            t.status, t.is_deleted, t.create_time, t.update_time,
            u.nickname as user_nickname, u.avatar as user_avatar
        FROM community_topic t
        LEFT JOIN sys_user u ON t.user_id = u.id AND u.is_deleted = 0
        WHERE t.is_deleted = 0 AND t.status = 1
        AND (t.title LIKE CONCAT('%', #{keyword}, '%')
        OR t.content LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY t.create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 查询热门话题 -->
    <select id="selectHotTopics" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM community_topic
        WHERE is_deleted = 0 AND status = 1
        <if test="boardLevel1 != null and boardLevel1 != ''">
            AND board_level1 = #{boardLevel1}
        </if>
        ORDER BY view_count DESC, like_count DESC, comment_count DESC
        LIMIT #{limit}
    </select>

    <!-- 查询推荐话题 -->
    <select id="selectRecommendTopics" resultMap="TopicWithUserResultMap">
        SELECT
            t.id, t.user_id, t.disease_code, t.board_level1, t.board_level2, t.board_type,
            t.title, t.content, t.like_count, t.comment_count, t.collect_count, t.view_count,
            t.status, t.is_deleted, t.create_time, t.update_time,
            u.nickname as user_nickname, u.avatar as user_avatar
        FROM community_topic t
        LEFT JOIN sys_user u ON t.user_id = u.id AND u.is_deleted = 0
        WHERE t.is_deleted = 0 AND t.status = 1
        ORDER BY t.view_count DESC, t.like_count DESC, t.create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 插入话题 -->
    <insert id="insert" parameterType="com.chen.HospitalSelection.model.Topic" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO community_topic (
            user_id, disease_code, board_level1, board_level2, board_type,
            title, content, like_count, comment_count, collect_count, view_count,
            status, is_deleted, create_time, update_time
        ) VALUES (
            #{userId}, #{diseaseCode}, #{boardLevel1}, #{boardLevel2}, #{boardType},
            #{title}, #{content}, #{likeCount}, #{commentCount}, #{collectCount}, #{viewCount},
            #{status}, #{isDeleted}, #{createTime}, #{updateTime}
        )
    </insert>

    <!-- 更新话题 -->
    <update id="update" parameterType="com.chen.HospitalSelection.model.Topic">
        UPDATE community_topic
        <set>
            <if test="diseaseCode != null">
                disease_code = #{diseaseCode},
            </if>
            <if test="boardLevel1 != null and boardLevel1 != ''">
                board_level1 = #{boardLevel1},
            </if>
            <if test="boardLevel2 != null">
                board_level2 = #{boardLevel2},
            </if>
            <if test="boardType != null">
                board_type = #{boardType},
            </if>
            <if test="title != null and title != ''">
                title = #{title},
            </if>
            <if test="content != null and content != ''">
                content = #{content},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 增加浏览量 -->
    <update id="incrementViewCount">
        UPDATE community_topic
        SET view_count = view_count + 1
        WHERE id = #{topicId}
    </update>

    <!-- 更新点赞数 -->
    <update id="updateLikeCount">
        UPDATE community_topic
        SET like_count = #{likeCount}
        WHERE id = #{topicId}
    </update>

    <!-- 更新评论数 -->
    <update id="updateCommentCount">
        UPDATE community_topic
        SET comment_count = #{commentCount}
        WHERE id = #{topicId}
    </update>

    <!-- 更新收藏数 -->
    <update id="updateCollectCount">
        UPDATE community_topic
        SET collect_count = #{collectCount}
        WHERE id = #{topicId}
    </update>

    <!-- 逻辑删除 -->
    <update id="deleteById">
        UPDATE community_topic
        SET is_deleted = 1
        WHERE id = #{id}
    </update>

    <!-- 批量逻辑删除 -->
    <update id="deleteBatch">
        UPDATE community_topic
        SET is_deleted = 1
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
