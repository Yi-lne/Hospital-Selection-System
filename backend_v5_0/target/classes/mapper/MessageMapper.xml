<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.HospitalSelection.mapper.MessageMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.chen.HospitalSelection.model.Message">
        <id column="id" property="id"/>
        <result column="sender_id" property="senderId"/>
        <result column="receiver_id" property="receiverId"/>
        <result column="content" property="content"/>
        <result column="is_read" property="isRead"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 私信详细信息映射（包含发送者和接收者信息） -->
    <resultMap id="MessageWithUsersResultMap" type="com.chen.HospitalSelection.model.Message" extends="BaseResultMap">
        <result column="sender_nickname" property="senderNickname"/>
        <result column="sender_avatar" property="senderAvatar"/>
        <result column="receiver_nickname" property="receiverNickname"/>
        <result column="receiver_avatar" property="receiverAvatar"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, sender_id, receiver_id, content, is_read, is_deleted, create_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 根据ID查询（包含用户信息） -->
    <select id="selectWithUsersById" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            s.nickname as sender_nickname, s.avatar as sender_avatar,
            r.nickname as receiver_nickname, r.avatar as receiver_avatar
        FROM user_message m
        LEFT JOIN sys_user s ON m.sender_id = s.id AND s.is_deleted = 0
        LEFT JOIN sys_user r ON m.receiver_id = r.id AND r.is_deleted = 0
        WHERE m.id = #{id} AND m.is_deleted = 0
    </select>

    <!-- 查询用户发送的所有私信（包含用户信息） -->
    <select id="selectBySenderWithUser" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            s.nickname as sender_nickname, s.avatar as sender_avatar,
            r.nickname as receiver_nickname, r.avatar as receiver_avatar
        FROM user_message m
        LEFT JOIN sys_user s ON m.sender_id = s.id AND s.is_deleted = 0
        LEFT JOIN sys_user r ON m.receiver_id = r.id AND r.is_deleted = 0
        WHERE m.sender_id = #{senderId} AND m.is_deleted = 0
        ORDER BY m.create_time DESC
    </select>

    <!-- 查询用户接收的所有私信（包含用户信息） -->
    <select id="selectByReceiverWithUser" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            s.nickname as sender_nickname, s.avatar as sender_avatar,
            r.nickname as receiver_nickname, r.avatar as receiver_avatar
        FROM user_message m
        LEFT JOIN sys_user s ON m.sender_id = s.id AND s.is_deleted = 0
        LEFT JOIN sys_user r ON m.receiver_id = r.id AND r.is_deleted = 0
        WHERE m.receiver_id = #{receiverId} AND m.is_deleted = 0
        ORDER BY m.create_time DESC
    </select>

    <!-- 查询两个用户之间的聊天记录（包含用户信息） -->
    <select id="selectBetweenUsersWithUser" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            s.nickname as sender_nickname, s.avatar as sender_avatar,
            r.nickname as receiver_nickname, r.avatar as receiver_avatar
        FROM user_message m
        LEFT JOIN sys_user s ON m.sender_id = s.id AND s.is_deleted = 0
        LEFT JOIN sys_user r ON m.receiver_id = r.id AND r.is_deleted = 0
        WHERE ((m.sender_id = #{userId1} AND m.receiver_id = #{userId2})
            OR (m.sender_id = #{userId2} AND m.receiver_id = #{userId1}))
        AND m.is_deleted = 0
        ORDER BY m.create_time ASC
    </select>

    <!-- 查询用户的收件箱（接收的消息） -->
    <select id="selectInbox" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            s.nickname as sender_nickname, s.avatar as sender_avatar
        FROM user_message m
        LEFT JOIN sys_user s ON m.sender_id = s.id AND s.is_deleted = 0
        WHERE m.receiver_id = #{userId} AND m.is_deleted = 0
        ORDER BY m.create_time DESC
    </select>

    <!-- 查询用户的发件箱（发送的消息） -->
    <select id="selectOutbox" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            r.nickname as receiver_nickname, r.avatar as receiver_avatar
        FROM user_message m
        LEFT JOIN sys_user r ON m.receiver_id = r.id AND r.is_deleted = 0
        WHERE m.sender_id = #{userId} AND m.is_deleted = 0
        ORDER BY m.create_time DESC
    </select>

    <!-- 查询两个用户之间的对话 -->
    <select id="selectConversation" resultMap="MessageWithUsersResultMap">
        SELECT
            m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.is_deleted, m.create_time,
            s.nickname as sender_nickname, s.avatar as sender_avatar,
            r.nickname as receiver_nickname, r.avatar as receiver_avatar
        FROM user_message m
        LEFT JOIN sys_user s ON m.sender_id = s.id AND s.is_deleted = 0
        LEFT JOIN sys_user r ON m.receiver_id = r.id AND r.is_deleted = 0
        WHERE ((m.sender_id = #{userId1} AND m.receiver_id = #{userId2})
            OR (m.sender_id = #{userId2} AND m.receiver_id = #{userId1}))
        AND m.is_deleted = 0
        ORDER BY m.create_time ASC
    </select>

    <!-- 查询未读消息 -->
    <select id="selectUnreadMessages" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE receiver_id = #{userId} AND is_read = 0 AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询接收者的未读消息 -->
    <select id="selectUnreadByReceiverId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE receiver_id = #{receiverId} AND is_read = 0 AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询发送者的未读消息 -->
    <select id="selectUnreadBySenderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE sender_id = #{senderId} AND is_read = 0 AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询用户发送的消息 -->
    <select id="selectBySenderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE sender_id = #{senderId} AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询用户接收的消息 -->
    <select id="selectByReceiverId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE receiver_id = #{receiverId} AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询两个用户之间的消息 -->
    <select id="selectBetweenUsers" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2})
            OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        AND is_deleted = 0
        ORDER BY create_time ASC
    </select>

    <!-- 查询所有消息 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询最近的聊天记录 -->
    <select id="selectRecentMessages" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE (sender_id = #{senderId} OR receiver_id = #{receiverId})
        AND is_deleted = 0
        ORDER BY create_time DESC
        LIMIT #{limit}
        OFFSET #{offset}
    </select>

    <!-- 查询最近的会话列表 -->
    <select id="selectRecentConversations" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user_message
        WHERE (sender_id = #{userId} OR receiver_id = #{userId}) AND is_deleted = 0
        GROUP BY
            CASE
                WHEN sender_id &lt; receiver_id THEN CONCAT(sender_id, '_', receiver_id)
                ELSE CONCAT(receiver_id, '_', sender_id)
            END
        ORDER BY MAX(create_time) DESC
        LIMIT #{limit}
    </select>

    <!-- 统计未读消息数 -->
    <select id="countUnread" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE receiver_id = #{userId} AND is_read = 0 AND is_deleted = 0
    </select>

    <!-- 统计收件箱消息数 -->
    <select id="countInbox" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE receiver_id = #{userId} AND is_deleted = 0
    </select>

    <!-- 统计发件箱消息数 -->
    <select id="countOutbox" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE sender_id = #{userId} AND is_deleted = 0
    </select>

    <!-- 统计发送者发送的消息数 -->
    <select id="countBySenderId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE sender_id = #{senderId} AND is_deleted = 0
    </select>

    <!-- 统计接收者接收的消息数 -->
    <select id="countByReceiverId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE receiver_id = #{receiverId} AND is_deleted = 0
    </select>

    <!-- 统计接收者的未读消息数 -->
    <select id="countUnreadByReceiverId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE receiver_id = #{receiverId} AND is_read = 0 AND is_deleted = 0
    </select>

    <!-- 统计两个用户之间的消息数 -->
    <select id="countConversation" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2})
            OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        AND is_deleted = 0
    </select>

    <!-- 统计两个用户之间的消息数 -->
    <select id="countBetweenUsers" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_message
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2})
            OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        AND is_deleted = 0
    </select>

    <!-- 插入私信 -->
    <insert id="insert" parameterType="com.chen.HospitalSelection.model.Message" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_message (sender_id, receiver_id, content, is_read, is_deleted, create_time)
        VALUES (#{senderId}, #{receiverId}, #{content}, #{isRead}, #{isDeleted}, #{createTime})
    </insert>

    <!-- 批量插入私信 -->
    <insert id="insertBatch">
        INSERT INTO user_message (sender_id, receiver_id, content, is_read, is_deleted, create_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.senderId}, #{item.receiverId}, #{item.content}, #{item.isRead}, #{item.isDeleted}, #{item.createTime})
        </foreach>
    </insert>

    <!-- 标记为已读 -->
    <update id="markAsRead">
        UPDATE user_message
        SET is_read = 1
        WHERE id = #{id}
    </update>

    <!-- 批量标记为已读 -->
    <update id="markBatchAsRead">
        UPDATE user_message
        SET is_read = 1
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 标记对话为已读 -->
    <update id="markConversationAsRead">
        UPDATE user_message
        SET is_read = 1
        WHERE sender_id = #{senderId} AND receiver_id = #{receiverId} AND is_read = 0 AND is_deleted = 0
    </update>

    <!-- 标记所有消息为已读 -->
    <update id="markAllAsRead">
        UPDATE user_message
        SET is_read = 1
        WHERE receiver_id = #{userId} AND is_read = 0 AND is_deleted = 0
    </update>

    <!-- 逻辑删除 -->
    <update id="deleteById">
        UPDATE user_message
        SET is_deleted = 1
        WHERE id = #{id}
    </update>

    <!-- 批量逻辑删除 -->
    <update id="deleteBatch">
        UPDATE user_message
        SET is_deleted = 1
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 删除对话 -->
    <update id="deleteConversation">
        UPDATE user_message
        SET is_deleted = 1
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2})
            OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        AND is_deleted = 0
    </update>

</mapper>