# 后端测试修复说明

## 修复日期
2026年1月31日

## 测试概况

### 测试文件统计
- **总测试文件数**: 16个
- **Controller测试**: 3个 (CommunityControllerTest, HospitalControllerTest, UserControllerTest)
- **Service测试**: 13个 (包括新创建的RoleServiceTest和FilterServiceTest)

### 测试状态
- **Service测试**: 128个测试全部通过 ✅
- **Controller测试**: 存在配置问题，已修复

## 已修复的问题

### 1. UserControllerTest - MockMvc配置问题
**问题**: 使用`@SpringBootTest`但缺少`@AutoConfigureMockMvc`注解
**修复**:
- 将`@AutoConfigureWebMvc`改为`@AutoConfigureMockMvc`

### 2. CommunityControllerTest - MockMvc配置问题
**问题**:
- 使用`@SpringBootTest`但缺少`@AutoConfigureMockMvc`注解
- 缺少测试配置类引用

**修复**:
- 将`@AutoConfigureWebMvc`改为`@AutoConfigureMockMvc`
- 添加测试配置类: `TestConfig.class` 和 `ControllerTestConfig.class`

### 3. HospitalControllerTest - Mapper扫描问题
**问题**: `@WebMvcTest`会加载主应用的`@MapperScan`，导致尝试创建真实的Mapper Bean
**修复**:
- 添加`excludeFilters`排除所有Mapper类
- 移除`@Import(ControllerTestConfig.class)`（避免冲突）

### 4. TestConfig - 不必要的@MapperScan
**问题**: TestConfig中的`@MapperScan`会与ControllerTestConfig中的Mock Bean冲突
**修复**:
- 从TestConfig中移除`@MapperScan`注解
- TestConfig现在只提供SqlSessionFactory和SqlSessionTemplate（用于集成测试）

### 5. ControllerTestConfig - Mock Bean被注释
**问题**: 所有Mapper的Mock Bean都被注释掉了
**修复**:
- 取消注释所有Mapper的@MockBean方法
- 添加缺失的`@Bean`导入

## 新创建的测试

### RoleServiceTest (30个测试方法)
测试角色服务的所有功能：
- 角色分配/移除
- 用户角色查询/检查
- 管理员权限检查
- 用户权限管理
- 角色CRUD操作

### FilterServiceTest (15个测试方法)
测试筛选服务的核心功能：
- 医院多条件筛选
- 医生多条件筛选
- 疾病推荐
- 匹配度计算

## 运行测试

### 方法1: 使用批处理脚本（推荐）
在Windows命令提示符或PowerShell中运行：
```cmd
cd D:\Projects\Software_Project\Hospital-Selection-System\backend
run_tests_fixed.bat
```

### 方法2: 使用Maven命令
```cmd
cd D:\Projects\Software_Project\Hospital-Selection-System\backend

# 运行所有测试
mvn clean test -Dfile.encoding=UTF-8

# 只运行Service测试
mvn test -Dtest=*ServiceTest -Dfile.encoding=UTF-8

# 只运行Controller测试
mvn test -Dtest=*ControllerTest -Dfile.encoding=UTF-8

# 运行特定测试
mvn test -Dtest=RoleServiceTest -Dfile.encoding=UTF-8
```

## 注意事项

### UTF-8编码
- 所有测试文件使用UTF-8编码
- 在Git Bash中运行测试可能会遇到编码问题
- **强烈建议**在Windows命令提示符(cmd)或PowerShell中运行测试

### Java版本
- 项目使用Java 8
- 请确保JAVA_HOME指向JDK 8

### 测试报告
测试运行后，报告将保存在：
```
backend/target/surefire-reports/
```

## 测试文件列表

### Controller测试
1. `CommunityControllerTest.java` - 社区功能测试 (11个测试)
2. `HospitalControllerTest.java` - 医院信息测试 (7个测试)
3. `UserControllerTest.java` - 用户管理测试 (7个测试)

### Service测试
1. `AreaServiceTest.java` - 地区服务 (8个测试)
2. `CollectionServiceTest.java` - 收藏服务 (14个测试)
3. `CommunityServiceTest.java` - 社区服务 (19个测试)
4. `DepartmentServiceTest.java` - 科室服务 (6个测试)
5. `DiseaseServiceTest.java` - 疾病服务 (7个测试)
6. `DoctorServiceTest.java` - 医生服务 (12个测试)
7. `FilterServiceTest.java` - 筛选服务 (15个测试) ⭐新增
8. `HospitalServiceTest.java` - 医院服务 (15个测试)
9. `MedicalHistoryServiceTest.java` - 病历服务 (9个测试)
10. `MessageServiceTest.java` - 消息服务 (11个测试)
11. `QueryHistoryServiceTest.java` - 查询历史 (11个测试)
12. `RoleServiceTest.java` - 角色服务 (30个测试) ⭐新增
13. `UserServiceTest.java` - 用户服务 (16个测试)

**总计**: 约182个测试方法

## 待验证项目
- [ ] RoleServiceTest和FilterServiceTest编译和运行
- [ ] 所有Controller测试通过
- [ ] 没有功能回归问题

## 联系方式
如有问题，请查看测试报告或运行日志。
