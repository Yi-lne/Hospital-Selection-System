<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.HospitalSelection.mapper.UserMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.chen.HospitalSelection.model.User">
        <id column="id" property="id"/>
        <result column="phone" property="phone"/>
        <result column="password" property="password"/>
        <result column="nickname" property="nickname"/>
        <result column="avatar" property="avatar"/>
        <result column="gender" property="gender"/>
        <result column="status" property="status"/>
        <result column="ban_start_time" property="banStartTime"/>
        <result column="ban_end_time" property="banEndTime"/>
        <result column="ban_reason" property="banReason"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 用户信息完整映射（包含角色） -->
    <resultMap id="UserWithRolesResultMap" type="com.chen.HospitalSelection.model.User" extends="BaseResultMap">
        <collection property="roles" javaType="java.util.List" ofType="com.chen.HospitalSelection.model.Role">
            <id column="role_id" property="id"/>
            <result column="role_name" property="roleName"/>
            <result column="role_code" property="roleCode"/>
        </collection>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, phone, password, nickname, avatar, gender, status,
        ban_start_time, ban_end_time, ban_reason,
        is_deleted, create_time, update_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 根据手机号查询 -->
    <select id="selectByPhone" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE phone = #{phone} AND is_deleted = 0
    </select>

    <!-- 根据昵称查询用户（排除指定用户ID） -->
    <select id="selectByNicknameExcludeId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE nickname = #{nickname} AND id != #{excludeUserId} AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 根据手机号查询（包含密码，用于登录） -->
    <select id="selectByPhoneForLogin" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE phone = #{phone} AND is_deleted = 0 AND status = 1
    </select>

    <!-- 查询所有用户 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <!-- 查询用户及其角色 -->
    <select id="selectUserWithRoles" resultMap="UserWithRolesResultMap">
        SELECT
            u.id, u.phone, u.password, u.nickname, u.avatar, u.gender, u.status,
            u.is_deleted, u.create_time, u.update_time,
            r.id as role_id, r.role_name, r.role_code
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id
        WHERE u.id = #{userId} AND u.is_deleted = 0
    </select>

    <!-- 条件查询 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        <where>
            is_deleted = 0
            <if test="phone != null and phone != ''">
                AND phone LIKE CONCAT('%', #{phone}, '%')
            </if>
            <if test="nickname != null and nickname != ''">
                AND nickname LIKE CONCAT('%', #{nickname}, '%')
            </if>
            <if test="gender != null">
                AND gender = #{gender}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 分页查询 -->
    <select id="selectByPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE is_deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (phone LIKE CONCAT('%', #{keyword}, '%')
            OR nickname LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 统计总数 -->
    <select id="countByCondition" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_user
        WHERE is_deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (phone LIKE CONCAT('%', #{keyword}, '%')
            OR nickname LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 插入用户 -->
    <insert id="insert" parameterType="com.chen.HospitalSelection.model.User" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_user (phone, password, nickname, avatar, gender, status, is_deleted, create_time, update_time)
        VALUES (#{phone}, #{password}, #{nickname}, #{avatar}, #{gender}, #{status}, #{isDeleted}, #{createTime}, #{updateTime})
    </insert>

    <!-- 更新用户 -->
    <update id="update" parameterType="com.chen.HospitalSelection.model.User">
        UPDATE sys_user
        <set>
            <if test="password != null and password != ''">
                password = #{password},
            </if>
            <if test="nickname != null and nickname != ''">
                nickname = #{nickname},
            </if>
            <if test="avatar != null">
                avatar = #{avatar},
            </if>
            <if test="gender != null">
                gender = #{gender},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 更新用户信息（接口方法名：updateById） -->
    <update id="updateById" parameterType="com.chen.HospitalSelection.model.User">
        UPDATE sys_user
        <set>
            <if test="password != null and password != ''">
                password = #{password},
            </if>
            <if test="nickname != null and nickname != ''">
                nickname = #{nickname},
            </if>
            <if test="avatar != null">
                avatar = #{avatar},
            </if>
            <if test="gender != null">
                gender = #{gender},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="banStartTime != null">
                ban_start_time = #{banStartTime},
            </if>
            <if test="banEndTime != null">
                ban_end_time = #{banEndTime},
            </if>
            <if test="banReason != null">
                ban_reason = #{banReason},
            </if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 更新最后登录时间 -->
    <update id="updateUpdateTime">
        UPDATE sys_user
        SET update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <!-- 更新用户状态 -->
    <update id="updateStatus">
        UPDATE sys_user
        SET status = #{status},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 更新密码 -->
    <update id="updatePassword">
        UPDATE sys_user
        SET password = #{password},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 逻辑删除 -->
    <update id="deleteById">
        UPDATE sys_user
        SET is_deleted = 1
        WHERE id = #{id}
    </update>

    <!-- 批量逻辑删除 -->
    <update id="deleteBatch">
        UPDATE sys_user
        SET is_deleted = 1
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 搜索用户 -->
    <select id="searchUsers" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE is_deleted = 0
        AND (phone LIKE CONCAT('%', #{keyword}, '%')
        OR nickname LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY create_time DESC
    </select>

</mapper>
